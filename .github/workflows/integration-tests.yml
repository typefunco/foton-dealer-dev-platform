name: ðŸ§ª Integration Tests

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:
    inputs:
      test_packages:
        description: 'Test packages (comma-separated)'
        required: false
        type: string
        default: './internal/service/...,./internal/repository/...,./internal/testutil/...'
      timeout_minutes:
        description: 'Test timeout in minutes'
        required: false
        type: string
        default: '30'

env:
  GO_VERSION: '1.24'
  TESTCONTAINERS_RYUK_DISABLED: true
  TESTCONTAINERS_HOST_OVERRIDE: localhost

jobs:
  integration-tests:
    name: ðŸ§ª Integration Tests
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./backend
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: backend/go.sum

      - name: Download dependencies
        run: go mod download

      - name: Verify dependencies
        run: go mod verify

      - name: Run integration tests
        env:
          JWT_SECRET: test-secret
          SERVER_PORT: 8080
          TESTCONTAINERS_RYUK_DISABLED: true
          TESTCONTAINERS_HOST_OVERRIDE: localhost
          TESTCONTAINERS_DOCKER_SOCKET_OVERRIDE: /var/run/docker.sock
        run: |
          echo "Running integration tests with Testcontainers..."
          echo "Test packages: ${{ github.event.inputs.test_packages || './internal/service/...,./internal/repository/...,./internal/testutil/...' }}"
          echo "Timeout: ${{ github.event.inputs.timeout_minutes || '30' }}m"
          
          go test -v -race -coverprofile=integration-coverage.out -covermode=atomic \
            ${{ github.event.inputs.test_packages || './internal/service/...,./internal/repository/...,./internal/testutil/...' }} \
            -timeout=${{ github.event.inputs.timeout_minutes || '30' }}m \
            -run "Test.*"

      - name: Generate coverage report
        run: |
          echo "Generating coverage report..."
          go tool cover -html=integration-coverage.out -o coverage.html
          go tool cover -func=integration-coverage.out

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: integration-coverage-${{ github.sha }}
          path: |
            backend/integration-coverage.out
            backend/coverage.html
          retention-days: 7

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./backend/integration-coverage.out
          flags: integration-tests
          name: integration-tests-coverage
          fail_ci_if_error: false
        continue-on-error: true

      - name: Test summary
        if: always()
        run: |
          echo "ðŸ§ª Integration Tests Summary"
          echo "============================="
          echo "Test packages: ${{ github.event.inputs.test_packages || './internal/service/...,./internal/repository/...,./internal/testutil/...' }}"
          echo "Timeout: ${{ github.event.inputs.timeout_minutes || '30' }}m"
          echo "Status: ${{ job.status }}"
          echo "============================="
          
          if [ -f integration-coverage.out ]; then
            echo "Coverage report generated successfully"
            echo "Coverage summary:"
            go tool cover -func=integration-coverage.out | tail -1
          else
            echo "No coverage report generated"
          fi
